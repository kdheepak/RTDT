<!DOCTYPE html>
<html>
  <head>
    <title>Bus Locations</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=yes">
    <meta charset="utf-8">
    <style>
      html, body {
        cursor: pointer;
        height: 100%;
        margin: 0;
        padding: 0;
      }
  div#info { width:100%; position:absolute; overflow:hidden; text-align:center; bottom:0;
    left:0; 
    filter:alpha(opacity=60);
    -moz-opacity:0.6;
    -khtml-opacity: 0.6;
    opacity: 0.6;
    background-color:white;
    padding:2px;
  }
  div#loading { width:100%; position:absolute; overflow:hidden; text-align:center; bottom:0;
    left:0;
    filter:alpha(opacity=100);
    -moz-opacity:1;
    -khtml-opacity:1 
    opacity: 1;
    background-color:white;
    padding:4px;
  }
      #map {
        height: 100%;
      }
    </style>
<!-- start Mixpanel --><script type="text/javascript">(function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f)}})(document,window.mixpanel||[]);
mixpanel.init("816ed6a8fcec6531046e86f537e9f09c");</script><!-- end Mixpanel -->
<script>
    mixpanel.track("Map") ;
</script>
  </head>
  <body>
      <script src="https://cdn.rawgit.com/HPNeo/gmaps/master/gmaps.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="{{
  url_for('static', filename='jquery.js') }}">\x3C/script>')</script>
<script type=text/javascript>
  $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
</script>
  </script>
    <script>
// Note: This example requires that you consent to location sharing when
// prompted by your browser. If you see the error "The Geolocation service
// failed.", it means you probably did not give permission for the browser to
// locate you.

var map = null
var pos = null

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: new google.maps.LatLng(39.7392, -104.9903),
    zoom: 15,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  });

  // Try HTML5 geolocation.
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };
      map.setCenter(pos);
      console.log("init_complete")
        $(document).trigger('init_complete');
    }, function() {
      handleLocationError(true);
    });
  } else {
    // Browser doesn't support Geolocation
    handleLocationError(false);
  }

}

function handleLocationError(browserHasGeolocation) {
    console.log(browserHasGeolocation)
        render()
}

    </script>
    <script type=text/javascript src="{{
    url_for('static', filename='jquery-1.12.0.min.js') }}"></script>

    <script src="https://maps.googleapis.com/maps/api/js?key={{ json_api_key }}&signed_in=true&callback=initMap"
        async defer>
    </script>

  <script type=text/javascript>

var data = []
var gmarkers = [];
var intervalNumber = 0;

function render()
    {
        console.log('Finding positions')
        console.log(pos)

        $.getJSON('/data',{
        info: 'set_position',
        data: JSON.stringify(pos)
      } )
       
    }

function getInfoCallback(map, content) {
    var infowindow = new google.maps.InfoWindow({content: content});
    return function() {
            infowindow.setContent(content);
            infowindow.open(map, this);
        };
}

function continueRender()
    {
    var bounds = new google.maps.LatLngBounds();

    var image = {
        url: '/static/transit.jpg',
        // This marker is 20 pixels wide by 32 pixels high.
        // size: new google.maps.Size(20, 32),
        // The origin for this image is (0, 0).
        origin: new google.maps.Point(0, 0),
        // The anchor for this image is the base of the flagpole at (0, 32).
        anchor: new google.maps.Point(0, 32),
        scaledSize: new google.maps.Size(25, 25)
      };
      // Shapes define the clickable region of the icon. The type defines an HTML
      // <area> element 'poly' which traces out a polygon as a series of X,Y points.
      // The final coordinate closes the poly by connecting to the first coordinate.
      var shape = {
        coords: [1, 1, 1, 20, 18, 20, 18, 1],
        type: 'poly'
      };

    for (var i = 0, length = data.markers["/static/transit.png"].length; i < length; i++) {

        var stop_data = data.markers["/static/transit.png"][i]

        console.log(stop_data)

        var contentString = '<div id="content">'+
      '<div id="siteNotice">'+
      '</div>'+
      '<h1 id="firstHeading" class="firstHeading">'+ stop_data[8] + ' ' + stop_data[9] + ' </h1>'+
      '<div id="bodyContent">'+
      'Expected to depart <b>'+
      stop_data[2]+
      '</b> at <b>'+
      stop_data[3]+
      // '</b>.'+
      // '.<br>Expected to depart <b>'+
      // stop_data[7]+
      // '</b> at <b>'+
      // stop_data[6]+
      '</b>.';
      if(stop_data[4] !== 0) {
        contentString = contentString + '<br>Delay - '+
      stop_data[4]+
      '<br>Uncertainty - '+
      stop_data[5];
        }
        contentString = contentString+
      '</p>'+
      '</div>'+
      '</div>';

        latLng = new google.maps.LatLng(stop_data[0], stop_data[1]);
        bounds.extend(latLng);
        var marker = new google.maps.Marker({
            position: latLng,
            map: map,
            animation: google.maps.Animation.DROP,
            icon: image,
            // opacity: 1,
            // optimized: false,
        });
        // getInfoCallback(map, contentString)();
        google.maps.event.addListener(marker, 'click',
                getInfoCallback(map, contentString));
    };


    $(document).trigger('render_complete');

}

function getInfoCallback(map, content) {
    var infowindow = new google.maps.InfoWindow({content: content});
    return function() {
            infowindow.setContent(content);
            infowindow.open(map, this);
        };
}


function removebox() {

    var div = document.getElementById('loading');
    // hide
    div.style.visibility = 'hidden';
    // OR
    div.style.display = 'none';


}

$(document).bind('init_complete', render);
$(document).bind('render_complete', removebox);

$.getJSON('/data',{
info: 'bus_list'
} , function(d) {
    d
    select = document.getElementById('routename');

    for (var i = 0, length = d.bus_list.length; i < length; i++){
        var opt = document.createElement('option');
                opt.value = d.bus_list[i];
                opt.innerHTML = d.bus_list[i];
                select.appendChild(opt);
    }
})


// setInterval(render, 5000);

function getData(sel) {
$.getJSON('/data',{
    info : 'request',
    data : sel.value
  }, function(d) {
            data = d
        })
.done(function( data ) {
        continueRender()
    });
}

</script>

  <select id='routename' onchange="getData(this)">
  </select>

    <div id="map" data-tap-disabled="true" ></div>
    <div id="info" class="lightbox"> Last updated on {{ last_modified }} </div>
    <div id="loading" class="lightbox"> Loading real time data ... </div>


  </body>
</html>
